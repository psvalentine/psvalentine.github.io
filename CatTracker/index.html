<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢—Ä–µ–∫–µ—Ä –ö–æ—Ç–æ–≤ üêà</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        h1 { margin-bottom: 20px; font-size: 1.5rem; }
        .setup-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .cat-card {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .cat-card.outside { border: 2px solid #ff9800; background: #fff8e1; }
        .cat-name { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .status { font-size: 1.2rem; margin: 10px 0; font-weight: bold; color: #4caf50; }
        .outside .status { color: #ff9800; }
        .timer { font-size: 2rem; font-family: monospace; color: #333; margin: 10px 0; }
        .info { color: #666; font-size: 0.9rem; margin-bottom: 15px; }
        
        button.action-btn {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            background: #4caf50; color: white;
            transition: background 0.2s;
        }
        button.action-btn:active { transform: scale(0.98); }
        .outside button.action-btn { background: #ff9800; color: black; }
        
        input { padding: 10px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; width: 80%; margin-bottom: 10px;}
        .save-btn { background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;}
        
        #history-log { text-align: left; margin-top: 30px; background: white; padding: 15px; border-radius: 12px; }
        .log-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 0.9rem; }
        .log-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div id="setup" class="setup-box">
        <h3>–ö—Ç–æ –≤—ã?</h3>
        <p>–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —á—Ç–æ–±—ã –∏—Å—Ç–æ—Ä–∏—è –∑–Ω–∞–ª–∞, –∫—Ç–æ –≤—ã–ø—É—Å—Ç–∏–ª –∫–æ—Ç–∞.</p>
        <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ê–ª–µ–∫—Å–µ–π)">
        <br>
        <button class="save-btn" onclick="saveUser()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div id="app" style="display:none;">
        <h1>üêà –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–æ—Ç–æ–≤</h1>
        <div id="cats-container"></div>
        
        <div id="history-log">
            <h3>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π:</h3>
            <div id="log-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <script type="module">
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º CDN —Å—Å—ã–ª–∫–∏, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ —Å–±–æ—Ä–∫–∏
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, orderBy, limit, addDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- –í–ê–®–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const firebaseConfig = {
            apiKey: "AIzaSyCfgJ44i1k7eU_HvH2S_yooGckivopXgJo",
            authDomain: "cattracker-b813e.firebaseapp.com",
            projectId: "cattracker-b813e",
            storageBucket: "cattracker-b813e.firebasestorage.app",
            messagingSenderId: "289911262006",
            appId: "1:289911262006:web:48d3c40ee80147612b0197"
        };
        // -------------------------

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // !!! –°–ü–ò–°–û–ö –ö–û–¢–û–í: –ü–û–ú–ï–ù–Ø–ô–¢–ï –ò–ú–ï–ù–ê –ó–î–ï–°–¨ !!!
        const MY_CATS = ["–ë–∞—Ä—Å–∏–∫", "–ú—É—Ä–∑–∏–∫"]; 

        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ?)
        const storedUser = localStorage.getItem('catUser');
        if(storedUser) {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }

        window.saveUser = () => {
            const name = document.getElementById('username').value;
            if(name) {
                localStorage.setItem('catUser', name);
                location.reload();
            }
        }

        const currentUser = localStorage.getItem('catUser') || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";

        // 2. –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ—Ç–æ–≤
        const container = document.getElementById('cats-container');
        MY_CATS.forEach(cat => {
            container.innerHTML += `
                <div class="cat-card" id="card-${cat}">
                    <div class="cat-name">${cat}</div>
                    <div class="status" id="status-${cat}">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="timer" id="timer-${cat}">00:00:00</div>
                    <div class="info" id="info-${cat}">–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</div>
                    <button class="action-btn" id="btn-${cat}">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
                </div>
            `;
        });

        // 3. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (Real-time)
        onSnapshot(collection(db, "status"), (snapshot) => {
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const catName = docSnap.id;
                // –ï—Å–ª–∏ –∏–º—è –∫–æ—Ç–∞ –µ—Å—Ç—å –≤ –Ω–∞—à–µ–º —Å–ø–∏—Å–∫–µ UI, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                if (document.getElementById(`card-${catName}`)) {
                    updateUI(catName, data);
                }
            });
        });

        // 4. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π)
        const q = query(collection(db, "history"), orderBy("timestamp", "desc"), limit(10));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('log-list');
            list.innerHTML = "";
            snapshot.forEach((doc) => {
                const d = doc.data();
                const date = new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', day: 'numeric', month: 'numeric'});
                const actionColor = d.isOutside ? "#ff9800" : "#4caf50";
                const actionText = d.isOutside ? "–≤—ã–ø—É—Å—Ç–∏–ª(–∞) –≥—É–ª—è—Ç—å" : "–≤–ø—É—Å—Ç–∏–ª(–∞) –¥–æ–º–æ–π";
                
                list.innerHTML += `
                    <div class="log-item">
                        <span style="color:#999; font-size:0.8em">${date}</span><br>
                        <b>${d.user}</b> <span style="color:${actionColor}">${actionText}</span> <b>${d.cat}</b>
                    </div>`;
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI(cat, data) {
            const card = document.getElementById(`card-${cat}`);
            const statusDiv = document.getElementById(`status-${cat}`);
            const infoDiv = document.getElementById(`info-${cat}`);
            const btn = document.getElementById(`btn-${cat}`);
            const timerDiv = document.getElementById(`timer-${cat}`);

            // –ù–∞–∑–Ω–∞—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∫–Ω–æ–ø–∫–µ
            btn.onclick = () => toggleCat(cat, data ? !data.isOutside : true);

            if (!data) {
                statusDiv.innerText = "–î–æ–º–∞ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)";
                return;
            }

            // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ –∏ —Ç–µ–∫—Å—Ç
            if (data.isOutside) {
                card.classList.add('outside');
                statusDiv.innerText = "üå≥ –ì–£–õ–Ø–ï–¢";
                btn.innerText = "–í–ø—É—Å—Ç–∏—Ç—å –¥–æ–º–æ–π";
                startTimer(cat, data.lastChange);
            } else {
                card.classList.remove('outside');
                statusDiv.innerText = "üè† –î–û–ú–ê";
                btn.innerText = "–í—ã–ø—É—Å—Ç–∏—Ç—å –≥—É–ª—è—Ç—å";
                stopTimer(cat);
                timerDiv.innerText = "00:00:00";
            }

            const timeStr = new Date(data.lastChange).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            infoDiv.innerText = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${data.user} –≤ ${timeStr}`;
        }

        // –õ–æ–≥–∏–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ (–∑–∞–ø–∏—Å—å –≤ –±–∞–∑—É)
        async function toggleCat(catName, goOutside) {
            const now = Date.now();
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç)
            await setDoc(doc(db, "status", catName), {
                isOutside: goOutside,
                lastChange: now,
                user: currentUser
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –æ–±—â—É—é –∏—Å—Ç–æ—Ä–∏—é
            await addDoc(collection(db, "history"), {
                cat: catName,
                isOutside: goOutside,
                user: currentUser,
                timestamp: now
            });
        }

        // --- –õ–æ–≥–∏–∫–∞ —Ç–∞–π–º–µ—Ä–∞ (—Å–µ–∫—É–Ω–¥–æ–º–µ—Ä) ---
        let intervals = {};
        
        function startTimer(cat, startTime) {
            if (intervals[cat]) clearInterval(intervals[cat]);
            
            // –§—É–Ω–∫—Ü–∏—è —Ç–∏–∫–∞
            const tick = () => {
                const now = Date.now();
                const diff = now - startTime;
                
                if (diff < 0) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                const el = document.getElementById(`timer-${cat}`);
                if(el) el.innerText = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            };

            tick(); // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–∑—É
            intervals[cat] = setInterval(tick, 1000);
        }

        function stopTimer(cat) {
            if (intervals[cat]) clearInterval(intervals[cat]);
        }

        function pad(n) { return n < 10 ? '0' + n : n; }
    </script>
</body>
</html>